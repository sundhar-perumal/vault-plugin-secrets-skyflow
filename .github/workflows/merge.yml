name: Merge to Main

on:
  push:
    branches:
      - main
      - develop

env:
  GO_VERSION: '1.25.0'

jobs:
  # Run tests after merge
  test:
    name: Post-Merge Tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true

      - name: Run tests with coverage
        run: go test -v -race -coverprofile=coverage.out -covermode=atomic ./...

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          file: ./coverage.out
          flags: unittests
          name: codecov-merge
          fail_ci_if_error: true

      - name: Generate coverage badge
        run: |
          COVERAGE=$(go tool cover -func=coverage.out | grep total | awk '{print $3}' | sed 's/%//')
          echo "Total coverage: $COVERAGE%"
          echo "COVERAGE=$COVERAGE" >> $GITHUB_ENV

  # Build and verify
  build:
    name: Build All Platforms
    runs-on: ubuntu-latest
    needs: test
    strategy:
      matrix:
        os: [linux, darwin, windows]
        arch: [amd64, arm64]
        exclude:
          - os: windows
            arch: arm64
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true

      - name: Build binary
        env:
          GOOS: ${{ matrix.os }}
          GOARCH: ${{ matrix.arch }}
        run: |
          if [ "${{ matrix.os }}" == "windows" ]; then
            go build -trimpath -ldflags="-s -w" -o bin/skyflow-plugin-${{ matrix.os }}-${{ matrix.arch }}.exe ./main.go
          else
            go build -trimpath -ldflags="-s -w" -o bin/skyflow-plugin-${{ matrix.os }}-${{ matrix.arch }} ./main.go
          fi

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: skyflow-plugin-${{ matrix.os }}-${{ matrix.arch }}
          path: bin/*
          retention-days: 30

  # Security audit
  security-audit:
    name: Security Audit
    runs-on: ubuntu-latest
    needs: test
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true

      - name: Run Gosec
        uses: securego/gosec@master
        with:
          args: '-fmt json -out gosec-report.json ./...'

      - name: Run govulncheck
        run: |
          go install golang.org/x/vuln/cmd/govulncheck@latest
          govulncheck ./...

      - name: Upload security reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: security-reports
          path: |
            gosec-report.json

  # Code quality metrics
  quality:
    name: Code Quality Metrics
    runs-on: ubuntu-latest
    needs: test
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true

      - name: Install gocyclo
        run: go install github.com/fzipp/gocyclo/cmd/gocyclo@latest

      - name: Check cyclomatic complexity
        run: |
          gocyclo -over 15 . || true

      - name: Count lines of code
        run: |
          echo "Lines of code:"
          find . -name '*.go' -not -path './vendor/*' | xargs wc -l | tail -n 1

      - name: Check test coverage
        run: |
          go test -coverprofile=coverage.out ./...
          COVERAGE=$(go tool cover -func=coverage.out | grep total | awk '{print $3}')
          echo "Test coverage: $COVERAGE"

  # Update development documentation
  update-docs:
    name: Update Development Docs
    runs-on: ubuntu-latest
    needs: [test, build, security-audit]
    if: github.ref == 'refs/heads/main'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: Generate API documentation
        run: |
          go install golang.org/x/tools/cmd/godoc@latest
          # Generate godoc if needed

      - name: Update CHANGELOG
        run: |
          # Get the last commit message
          LAST_COMMIT=$(git log -1 --pretty=%B)
          DATE=$(date +%Y-%m-%d)
          
          # Check if CHANGELOG.md exists, create if not
          if [ ! -f CHANGELOG.md ]; then
            cat > CHANGELOG.md << EOF
          # Changelog
          
          All notable changes to this project will be documented in this file.
          
          The format is based on [Keep a Changelog](https://keepachangelog.com/en/1.0.0/),
          and this project adheres to [Semantic Versioning](https://semver.org/spec/v2.0.0.html).
          
          ## [Unreleased]
          
          ### Changed
          - ${LAST_COMMIT}
          
          EOF
          fi

      - name: Commit documentation updates
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          if [ -n "$(git status --porcelain)" ]; then
            git add .
            git commit -m "docs: update documentation [skip ci]" || true
            git push || true
          fi

  # Notify team on main branch merge
  notify-slack:
    name: Notify Team
    runs-on: ubuntu-latest
    needs: [test, build, security-audit, quality]
    if: always() && github.ref == 'refs/heads/main'
    steps:
      - name: Prepare notification
        id: prepare
        run: |
          if [ "${{ needs.test.result }}" == "success" ] && \
             [ "${{ needs.build.result }}" == "success" ] && \
             [ "${{ needs.security-audit.result }}" == "success" ]; then
            echo "status=✅ Success" >> $GITHUB_OUTPUT
            echo "color=good" >> $GITHUB_OUTPUT
          else
            echo "status=❌ Failed" >> $GITHUB_OUTPUT
            echo "color=danger" >> $GITHUB_OUTPUT
          fi

      - name: Send notification (placeholder)
        run: |
          echo "Notification: ${{ steps.prepare.outputs.status }}"
          echo "Commit: ${{ github.sha }}"
          echo "Author: ${{ github.actor }}"
          echo "Branch: ${{ github.ref }}"
          # Add Slack webhook integration here if needed
          # curl -X POST -H 'Content-type: application/json' \
          #   --data '{"text":"Build ${{ steps.prepare.outputs.status }}"}' \
          #   ${{ secrets.SLACK_WEBHOOK_URL }}

  # Performance benchmarks
  benchmark:
    name: Performance Benchmarks
    runs-on: ubuntu-latest
    needs: test
    if: github.ref == 'refs/heads/main'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true

      - name: Run benchmarks
        run: |
          go test -bench=. -benchmem -run=^$ ./... > benchmark.txt
          cat benchmark.txt

      - name: Upload benchmark results
        uses: actions/upload-artifact@v4
        with:
          name: benchmark-results
          path: benchmark.txt
          retention-days: 30

      - name: Compare with previous benchmarks
        run: |
          echo "Benchmark comparison (implement if needed)"
          # Could use benchstat or similar tools to compare

  # Tag suggestion for next release
  suggest-version:
    name: Suggest Next Version
    runs-on: ubuntu-latest
    needs: [test, build]
    if: github.ref == 'refs/heads/main'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get latest tag
        id: get_tag
        run: |
          LATEST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "v0.0.0")
          echo "latest_tag=$LATEST_TAG" >> $GITHUB_OUTPUT
          echo "Latest tag: $LATEST_TAG"

      - name: Suggest next version
        run: |
          LATEST_TAG="${{ steps.get_tag.outputs.latest_tag }}"
          VERSION=${LATEST_TAG#v}
          
          IFS='.' read -ra PARTS <<< "$VERSION"
          MAJOR=${PARTS[0]}
          MINOR=${PARTS[1]}
          PATCH=${PARTS[2]}
          
          # Suggest patch version bump
          NEXT_PATCH="v${MAJOR}.${MINOR}.$((PATCH + 1))"
          NEXT_MINOR="v${MAJOR}.$((MINOR + 1)).0"
          NEXT_MAJOR="v$((MAJOR + 1)).0.0"
          
          echo "Current version: $LATEST_TAG"
          echo "Suggested versions:"
          echo "  - Patch: $NEXT_PATCH (for bug fixes)"
          echo "  - Minor: $NEXT_MINOR (for new features)"
          echo "  - Major: $NEXT_MAJOR (for breaking changes)"
          echo ""
          echo "To create a release, run:"
          echo "  git tag $NEXT_PATCH && git push origin $NEXT_PATCH"

  # Summary job
  summary:
    name: Merge Summary
    runs-on: ubuntu-latest
    needs: [test, build, security-audit, quality]
    if: always()
    steps:
      - name: Generate summary
        run: |
          echo "## Merge to Main Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Tests | ${{ needs.test.result == 'success' && '✅ Passed' || '❌ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Build | ${{ needs.build.result == 'success' && '✅ Passed' || '❌ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Security | ${{ needs.security-audit.result == 'success' && '✅ Passed' || '❌ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Quality | ${{ needs.quality.result == 'success' && '✅ Passed' || '❌ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "**Author:** ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY