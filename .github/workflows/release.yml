name: Release

on:
  push:
    branches: [master, main]

permissions:
  contents: write

jobs:
  # Calculate version FIRST so it can be used in build
  calculate-version:
    name: Calculate Version
    runs-on: sre-aws-build
    outputs:
      new_tag: ${{ steps.version.outputs.new_tag }}
      bump_type: ${{ steps.version.outputs.bump_type }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.SRE_GIT_READ_TOKEN }}

      - name: Calculate next version
        id: version
        shell: bash
        run: |
          # Get latest tag
          LATEST_TAG=$(git tag -l "v*.*.*" | sort -V | tail -1)
          
          if [ -z "$LATEST_TAG" ]; then
            # No tags exist, start with v0.1.0
            NEW_TAG="v0.1.0"
            BUMP_TYPE="initial"
          else
            # Extract version numbers
            VERSION=${LATEST_TAG#v}
            MAJOR=$(echo $VERSION | cut -d. -f1)
            MINOR=$(echo $VERSION | cut -d. -f2)
            PATCH=$(echo $VERSION | cut -d. -f3)
            
            # Detect merged branch from commit message
            COMMIT_MSG=$(git log -1 --pretty=%B)
            echo "Last commit: $COMMIT_MSG"
            
            # Check if it's a hotfix branch merge
            if echo "$COMMIT_MSG" | grep -qiE "(hotfix-|from.*hotfix-)"; then
              # Patch bump
              NEW_PATCH=$((PATCH + 1))
              NEW_TAG="v${MAJOR}.${MINOR}.${NEW_PATCH}"
              BUMP_TYPE="patch"
            else
              # Minor bump (feature branches, direct commits, everything else)
              NEW_MINOR=$((MINOR + 1))
              NEW_TAG="v${MAJOR}.${NEW_MINOR}.0"
              BUMP_TYPE="minor"
            fi
          fi
          
          echo "new_tag=$NEW_TAG" >> $GITHUB_OUTPUT
          echo "bump_type=$BUMP_TYPE" >> $GITHUB_OUTPUT
          echo "✅ Next version: $NEW_TAG ($BUMP_TYPE bump)"

  # TODO: Re-enable when golangci-lint supports Go 1.25
  # lint:
  #   name: Lint
  #   uses: ./.github/workflows/lint.yml
  #   with:
  #     go-version: '1.25'
  #   secrets:
  #     SRE_GIT_READ_TOKEN: ${{ secrets.SRE_GIT_READ_TOKEN }}

  lint-skipped:
    name: Lint (Skipped)
    runs-on: sre-aws-build
    steps:
      - name: Lint temporarily disabled
        run: |
          echo "::warning::⚠️ Lint is temporarily disabled - golangci-lint does not yet support Go 1.25"
          echo "See: https://github.com/golangci/golangci-lint/issues for updates"

  build:
    name: Build
    runs-on: sre-aws-build
    needs: [calculate-version]  # TODO: Add lint back when golangci-lint supports Go 1.25
    env:
      GITHUB_TOKEN: ${{ secrets.SRE_GIT_READ_TOKEN }}
    steps:
      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.25'
          cache: false

      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure Git for private modules
        shell: bash
        run: |
          git config --global url."https://${{ secrets.SRE_GIT_READ_TOKEN }}@github.com/".insteadOf "https://github.com/"

      - name: Build with version
        shell: bash
        env:
          VERSION: ${{ needs.calculate-version.outputs.new_tag }}
        run: |
          echo "Building with version: $VERSION"
          go build -v -ldflags "-X main.Version=$VERSION" -o bin/skyflow-plugin ./cmd

  test:
    name: Test
    uses: ./.github/workflows/test-coverage.yml
    with:
      go-version: '1.25'
      retention-days: 90
      create-pr-comment: false
      run-sonarqube: true
    secrets:
      SRE_GIT_READ_TOKEN: ${{ secrets.SRE_GIT_READ_TOKEN }}
      SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
      SONAR_HOST_URL: ${{ secrets.SONAR_HOST_URL }}

  create-tag:
    name: Create Version Tag
    runs-on: sre-aws-build
    needs: [calculate-version, build, test]
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.SRE_GIT_READ_TOKEN }}

      - name: Create and push tag
        shell: bash
        env:
          NEW_TAG: ${{ needs.calculate-version.outputs.new_tag }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git tag -a $NEW_TAG -m "Release $NEW_TAG"
          git push origin $NEW_TAG
          echo "✅ Tag $NEW_TAG created and pushed"
