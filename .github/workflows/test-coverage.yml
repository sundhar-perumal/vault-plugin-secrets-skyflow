name: Test and Coverage

on:
  workflow_call:
    inputs:
      go-version:
        description: 'Go version to use'
        required: false
        type: string
        default: '1.25'
      retention-days:
        description: 'Artifact retention days'
        required: false
        type: number
        default: 30
      create-pr-comment:
        description: 'Create PR comment with coverage'
        required: false
        type: boolean
        default: false
      run-sonarqube:
        description: 'Run SonarQube analysis'
        required: false
        type: boolean
        default: false
    secrets:
      SRE_GIT_READ_TOKEN:
        required: true
      SONAR_TOKEN:
        required: false
      SONAR_HOST_URL:
        required: false

jobs:
  test:
    name: Test with Coverage
    runs-on: sre-aws-build
    env:
      GITHUB_TOKEN: ${{ secrets.SRE_GIT_READ_TOKEN }}
    steps:
      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ inputs.go-version }}
          cache: false

      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Configure Git for private modules
        shell: bash
        run: |
          git config --global url."https://${{ secrets.SRE_GIT_READ_TOKEN }}@github.com/".insteadOf "https://github.com/"

      - name: Install Test Tools
        shell: bash
        run: |
          go install gotest.tools/gotestsum@latest
          go install github.com/ctrf-io/go-ctrf-json-reporter/cmd/go-ctrf-json-reporter@latest

      - name: Run Tests with Coverage
        shell: bash
        run: |
          gotestsum --format standard-verbose --jsonfile gotestsum.json -- -race -coverprofile=coverage.out -covermode=atomic ./...

      - name: Generate CTRF Report
        shell: bash
        run: go-ctrf-json-reporter < gotestsum.json
        if: always()

      - name: Generate Coverage Report
        shell: bash
        run: |
          echo "## Test Coverage Report" > coverage-report.md
          echo "" >> coverage-report.md
          echo "### Overall Coverage" >> coverage-report.md
          go tool cover -func=coverage.out | tail -1 >> coverage-report.md
          echo "" >> coverage-report.md
          echo "### Package Coverage" >> coverage-report.md
          echo '```' >> coverage-report.md
          go tool cover -func=coverage.out >> coverage-report.md
          echo '```' >> coverage-report.md
          
          COVERAGE=$(go tool cover -func=coverage.out | tail -1 | awk '{print $3}')
          echo "COVERAGE=$COVERAGE" >> $GITHUB_ENV
          echo "Coverage: $COVERAGE"

      - name: Generate HTML Coverage Report
        shell: bash
        run: go tool cover -html=coverage.out -o coverage.html

      - name: Upload Coverage Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: coverage-reports-${{ github.run_id }}
          path: |
            coverage.out
            coverage.html
            coverage-report.md
          retention-days: ${{ inputs.retention-days }}

      - name: Comment Coverage on PR
        uses: actions/github-script@v7
        if: inputs.create-pr-comment && github.event_name == 'pull_request'
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const coverage = process.env.COVERAGE;
            const reportPath = 'coverage-report.md';
            let coverageReport = '';
            
            if (fs.existsSync(reportPath)) {
              coverageReport = fs.readFileSync(reportPath, 'utf8');
            }
            
            const body = `## üìä Coverage Report
            
            **Overall Coverage:** \`${coverage}\`
            
            ${coverageReport}
            
            üìÅ [Download detailed HTML report](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
            `;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });

      - name: Publish Test Report
        uses: ctrf-io/github-test-reporter@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          report-path: './ctrf*.json'
          pull-request-report: true
          title: "Test Results"
        if: always()

      - name: SonarQube Scan
        uses: sonarsource/sonarqube-scan-action@v3.1.0
        if: inputs.run-sonarqube
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          SONAR_HOST_URL: ${{ secrets.SONAR_HOST_URL }}

      # FUTURE: Enable when Codecov license is available
      # - name: Upload to Codecov
      #   uses: codecov/codecov-action@v4
      #   with:
      #     file: ./coverage.out
      #     flags: unittests
      #     name: codecov-umbrella

